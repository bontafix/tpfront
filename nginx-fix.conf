# ИСПРАВЛЕННАЯ конфигурация для блока /alex/
# ВАЖНО: Именованный location @alex_fallback должен быть НА УРОВНЕ SERVER,
# а НЕ внутри блока location ^~ /alex/
#
# Замените существующий блок location ^~ /alex/ и добавьте именованный location
# на том же уровне (внутри блока server, но вне location блоков)

# Обработка запроса без завершающего слэша (должен быть ПЕРЕД блоком /alex/)
location = /alex {
    return 301 /alex/;
}

# Основной блок для /alex/
location ^~ /alex/ {
    # Корневая директория для тестовой версии
    alias /var/www/dev-tp-alex/;
    
    access_log /var/log/nginx/tp/www-alex-access.log;
    error_log /var/log/nginx/tp/www-alex-error.log;
    
    index index.html;
    
    # КРИТИЧЕСКИ ВАЖНО: при использовании alias нужно использовать именованный location
    # для правильной обработки SPA роутинга
    try_files $uri $uri/ @alex_fallback;
    
    # Статические файлы для тестовой версии (вложенный location имеет приоритет)
    location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|eot|ttf|svg|mp4)$ {
        expires 6M;
        access_log off;
        add_header Cache-Control "public";
    }
}

# Именованный location для fallback - ДОЛЖЕН БЫТЬ НА УРОВНЕ SERVER (не внутри location ^~ /alex/)
# Возвращает index.html для всех маршрутов SPA
location @alex_fallback {
    rewrite ^/alex/(.*)$ /index.html break;
    root /var/www/dev-tp-alex;
}

