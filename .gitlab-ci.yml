# .gitlab-ci.yml
stages:
  - deploy

variables:
  GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no"

# –î–µ–ø–ª–æ–π –Ω–∞ DEV
deploy_dev:
  stage: deploy
  tags:
    - front
  only:
    - dev
  before_script:
    - node --version
    - npm --version
  script:
    - echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    - npm ci
    - echo "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ .env.development..."
    - echo "VITE_API_URL=${DEV_API_URL}" > .env.development
    - echo "VITE_API_WS_URL=${DEV_WS_URL}" >> .env.development
    - cat .env.development
    - echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (DEVELOPMENT —Ä–µ–∂–∏–º)..."
    - npm run build:dev
    - echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
    - echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ DEV —Å–µ—Ä–≤–µ—Ä..."
    - echo "üìÇ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ /var/www/dev-teacherplanner"
    - mkdir -p /var/www/dev-teacherplanner
    - rsync -rlDv --delete dist/ /var/www/dev-teacherplanner
    - echo "‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ DEV –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  environment:
    name: development
    url: https://dev-teacherplanner.ru

# –î–µ–ø–ª–æ–π –Ω–∞ PROD
deploy_prod:
  stage: deploy
  tags:
    - front
  only:
    - main
  before_script:
    - node --version
    - npm --version
    - whoami
    - pwd
    - ls -la
  script:
    - echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    - npm ci
    - echo "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ .env.production..."
    - echo "VITE_API_URL=${PROD_API_URL}" > .env.production
    - echo "VITE_API_WS_URL=${PROD_WS_URL}" >> .env.production
    - cat .env.production
    - echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (PRODUCTION —Ä–µ–∂–∏–º)..."
    - npm run build:prod
    - echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
    - echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ dist/:"git status
    - ls -la dist/
    - echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ PROD —Å–µ—Ä–≤–µ—Ä..."
    - echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏git —è..."
    - ssh teacherplanner-prod "whoami && ls -la /var/www/teacherplanner/"
    - echo "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
    - rsync -rlDv --delete dist/ teacherplanner-prod:/var/www/teacherplanner/
    - echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
    - ssh teacherplanner-prod "ls -la /var/www/teacherplanner/"
    - echo "‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ PROD –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  environment:
    name: production
    url: https://teacherplanner.ru